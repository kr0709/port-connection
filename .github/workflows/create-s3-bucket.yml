name: Create S3 Bucket

on:
  workflow_dispatch:
    inputs:
      port_context:
        description: "Port.io context info"
        required: false
      bucket_name:
        description: "Name of the S3 bucket to create"
        required: true
      region:
        description: "AWS region for the S3 bucket"
        required: true

jobs:
  create-bucket:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.region }}

      - name: Create S3 bucket
        run: |
          BUCKET_NAME="${{ github.event.inputs.bucket_name }}"
          REGION="${{ github.event.inputs.region }}"
          echo "Port.io context: ${{ github.event.inputs.port_context }}"
          echo "Creating bucket: $BUCKET_NAME in region: $REGION"

          # Check if bucket already exists
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket $BUCKET_NAME already exists, skipping creation."
          else
            aws s3api create-bucket \
              --bucket "$BUCKET_NAME" \
              --region "$REGION" \
              --create-bucket-configuration LocationConstraint="$REGION"
            echo "Bucket $BUCKET_NAME created successfully."
          fi
